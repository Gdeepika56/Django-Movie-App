{% extends "home/base.html" %}

{% block title %}
    Comments
{% endblock %}

{% block main %}
    <h1>Comment page for {{ title }} </h1>
    <form method="POST">
        {% csrf_token %}
        <div class="form-group">
            <label for="comment">Comment:</label>
            <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>

    {% for c in comments %}
    <div>
        {{ c.user }} on {{ c.created_at }} said: <br> {{ c.comment }}  
    </div>
    <br>     
    {% endfor %}
     <!-- Bootstrap Modal for comment confirmation -->
     <div class="modal fade" id="commentConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="commentConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="commentConfirmationModalLabel">Comment Confirmation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">Ã—</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to add this comment?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmComment">Confirm</button>
                </div>
            </div>
        </div>
    </div>

   <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Function to show the comment confirmation modal
        function showConfirmationModal() {
            $('#commentConfirmationModal').modal('show');
        }

        // Function to fetch and update comments using AJAX
        function fetchAndDisplayComments() {
            fetch(`{% url 'comment_page' movie_id=movie_id %}`)
                .then(response => response.json())
                .then(data => {
                    // Update the comments container
                    $('#commentsContainer').html('');
                    data.comments.forEach(comment => {
                        $('#commentsContainer').append(`
                            <div>${comment.user} on ${comment.created_at} said: <br>${comment.comment}</div><br>
                        `);
                    });
                })
                .catch(error => {
                    console.error('Error fetching comments:', error);
                });
        }

        // Function to handle comment submission using AJAX
        function submitComment() {
            var formData = new FormData(document.getElementById('commentForm'));

            // Show confirmation modal before submitting the comment
            showConfirmationModal();

            // Event listener for the Confirm button in the modal
            $('#confirmComment').on('click', function () {
                fetch("{% url 'comment_page' movie_id=movie_id %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        // Clear the form after successful submission
                        document.getElementById('commentForm').reset();

                        // Fetch and display updated comments without reloading the page
                        fetchAndDisplayComments();
                    })
                    .catch(error => {
                        console.error('Error submitting comment:', error);
                    });
            });
        }

        // Event listener for the Submit button
        $('#submitComment').on('click', function () {
            submitComment();
        });
    });
</script>
{% endblock %}
